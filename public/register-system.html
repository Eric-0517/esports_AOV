<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>傳說對決線上賽事報名系統</title>
<link rel="stylesheet" href="css/register-system.css">
<script src="js/register-system.js" defer></script>
</head>
<body>

<!-- 主視覺 -->
<div class="main-visual">
  <img src="images/main_visual2.png" class="main-visual-img" alt="主視覺">
</div>

<!-- 導覽列 -->
<nav class="nav-bar">
  <div class="nav-left">
    親愛的 <span id="username" class="username visitor">訪客</span> 你好
  </div>
  <div class="nav-right" id="nav-right">
    <button class="btn-login" id="login-btn">Discord 登入</button>
  </div>
</nav>

<!-- 賽事首頁 -->
<section id="event-home" class="event-section page-section">
  <h2 class="event-title">最新賽事資訊</h2>
  <div id="event-list" class="event-list"></div>
  <p id="no-event" class="no-event hidden">近期尚未舉辦任何賽事！</p>
</section>

<!-- 個人資料頁 -->
<section id="profile-page" class="player-section page-section hidden">
  <div class="player-nav">
    <button class="btn-back" id="back-home">回賽事首頁</button>
    <button class="btn-logout" id="logout-btn">登出</button>
  </div>
  <h2 class="player-title">個人資料</h2>
  <div class="player-info-box">
    <p>Discord 名稱：<span id="p-discord"></span></p>
    <p>遊戲暱稱：<input type="text" id="p-nickname"></p>
    <p>遊戲排位：<input type="text" id="p-rank"></p>
    <p>真實姓名：<input type="text" id="p-realname"></p>
    <p>連絡電話：<input type="text" id="p-phone"></p>
    <p>電子信箱：<input type="email" id="p-email"></p>
    <p>生日：<input type="date" id="p-birthday"></p>
    <p>是否居住台灣：
      <select id="p-taiwan">
        <option value="是">是</option>
        <option value="否">否</option>
      </select>
    </p>
    <p>身分證字號：<input type="text" id="p-id"></p>
  </div>
  <div class="btn-row">
    <button id="cancel-profile">取消</button>
    <button id="save-profile">完成</button>
  </div>
  <div class="divide-line"></div>
  <h3>已報名賽事</h3>
  <div id="joined-events" class="joined-events-list"></div>
  <p id="no-joined" class="no-event hidden">尚無已報名賽事</p>
</section>

<!-- 隊長報名頁 -->
<section id="leader-page" class="player-section page-section hidden">
  <div class="player-nav">
    <button class="btn-back" id="back-home-leader">取消</button>
  </div>
  <h2 class="player-title">隊長報名</h2>
  <p>隊長資訊由登入帳號自動帶入</p>
  <div class="leader-info-box">
    <p>Discord 名稱：<span id="leader-discord"></span></p>
  </div>
  <div class="btn-row">
    <button id="next-leader">下一步</button>
  </div>
</section>

<!-- 隊員報名頁 -->
<section id="member-page" class="player-section page-section hidden">
  <div class="player-nav">
    <button class="btn-back" id="back-home-member">取消</button>
  </div>
  <h2 class="player-title">隊員報名</h2>
  <p>玩家序號由系統生成</p>
  <div class="btn-row">
    <button id="confirm-member">確認報名</button>
  </div>
</section>

<!-- 系統通知 Modal -->
<div id="system-modal" class="modal hidden">
  <div class="modal-content">
    <h3 class="modal-title">系統通知</h3>
    <p id="modal-text" class="modal-text">請先登入</p>
    <button class="modal-btn" id="modal-confirm">確認</button>
  </div>
</div>

<script>
let isLoggedIn = false;
let username = "訪客";

const usernameEl = document.getElementById("username");
const navRight = document.getElementById("nav-right");
const modal = document.getElementById("system-modal");
const modalText = document.getElementById("modal-text");
const modalConfirm = document.getElementById("modal-confirm");

const events = [
  { name: "AOV 線上賽 - 測試賽事", date: "2025/11/30", signup: "2025/11/20 - 2025/11/25", status: "報名中" }
];

const clientId = "1403970810762363013";
const backendCallback = "https://esportsmoba.dpdns.org/auth/discord/callback";
const scope = "identify";

window.onload = () => {
  renderEvents();
  updateUserUI();

  // 取得 JWT
  const urlParams = new URLSearchParams(window.location.search);
  const token = urlParams.get("token");
  if (token) handleToken(token);
};

function updateUserUI() {
  usernameEl.textContent = username;

  // 隊長報名自動帶入
  const leaderDiscord = document.getElementById("leader-discord");
  if (leaderDiscord) leaderDiscord.textContent = username;

  if (!isLoggedIn) {
    navRight.innerHTML = `<button class="btn-login" id="login-btn">Discord 登入</button>`;
    document.getElementById("login-btn").onclick = login;
  } else {
    navRight.innerHTML = `
      <button class="btn-login" onclick="goProfile()">個人資訊/已報名資訊</button>
      <button class="btn-login" onclick="logout()">登出</button>
    `;
  }
}

function login() {
  const oauthUrl =
    `https://discord.com/oauth2/authorize` +
    `?client_id=${clientId}` +
    `&redirect_uri=${encodeURIComponent(backendCallback)}` +
    `&response_type=code` +
    `&scope=${encodeURIComponent(scope)}`;
  window.location.href = oauthUrl;
}

function logout() {
  isLoggedIn = false;
  username = "訪客";
  switchPage("event-home");
  updateUserUI();
}

function handleToken(token) {
  try {
    const payload = JSON.parse(atob(token.split('.')[1]));
    username = payload.username || "Discord使用者";
    isLoggedIn = true;
    updateUserUI();
    history.replaceState(null, "", "register-system.html");
  } catch (err) {
    console.error("JWT 解析錯誤:", err);
  }
}

function switchPage(pageId) {
  const pages = ["event-home","profile-page","leader-page","member-page"];
  pages.forEach(id => { const el = document.getElementById(id); if(el) el.style.display="none"; });
  const target = document.getElementById(pageId);
  if(target) target.style.display="block";
}

function renderEvents() {
  const list = document.getElementById("event-list");
  const noEvent = document.getElementById("no-event");
  list.innerHTML = "";
  if(events.length===0){ noEvent.classList.remove("hidden"); return; } else { noEvent.classList.add("hidden"); }
  events.forEach(ev=>{
    const div=document.createElement("div");
    div.className="event-card";
    div.innerHTML=`
      <div class="event-name">${ev.name}</div>
      <div class="event-info">比賽日期：${ev.date}</div>
      <div class="event-info">報名時間：${ev.signup}</div>
      <div class="event-info">狀態：${ev.status}</div>
      <div class="card-btn-row">
        <div class="card-btn" onclick="goSignup('team')">團體報名</div>
        <div class="card-btn" onclick="goSignup('solo')">個人報名</div>
      </div>
    `;
    list.appendChild(div);
  });
}

function goSignup(type){ 
  if(!isLoggedIn){ showModal("請先登入 Discord"); return; }
  type==="team"?switchPage("leader-page"):switchPage("member-page");
}
function goProfile(){ if(!isLoggedIn){ showModal("請先登入 Discord"); return; } switchPage("profile-page"); }
function goEventHome(){ switchPage("event-home"); }

function showModal(msg){ modalText.textContent=msg; modal.classList.remove("hidden"); }
modalConfirm.onclick = ()=> modal.classList.add("hidden");

document.getElementById("save-profile")?.addEventListener("click",()=>{ alert("個人資料已更新"); goEventHome(); });
document.getElementById("cancel-profile")?.addEventListener("click", goEventHome);
document.getElementById("cancel-leader")?.addEventListener("click", goEventHome);
document.getElementById("next-leader")?.addEventListener("click", ()=> switchPage("member-page"));
document.getElementById("cancel-member")?.addEventListener("click", goEventHome);
document.getElementById("confirm-member")?.addEventListener("click", ()=> { alert("報名完成"); goEventHome(); });
</script>

</body>
</html>
