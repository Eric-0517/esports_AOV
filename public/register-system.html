// ä½ çš„å¾Œç«¯ API ç¶²åŸŸ
const BACKEND = "https://esportsmoba.dpdns.org";

// Discord OAuth2 å›ºå®šè¨­å®š
const CLIENT_ID = "1403970810762363013";
const REDIRECT_URI = "https://esportsmoba.dpdns.org/register-system.html";
const SCOPE = "identify";

// =====================================================================
// 1. æŒ‰ä¸‹ç™»å…¥ â†’ è·³è½‰ Discord OAuth2
// =====================================================================
document.getElementById("login-btn").addEventListener("click", () => {
    const authUrl =
        "https://discord.com/oauth2/authorize" +
        "?client_id=" + CLIENT_ID +
        "&redirect_uri=" + encodeURIComponent(REDIRECT_URI) +
        "&response_type=code" +
        "&scope=" + SCOPE;

    window.location.href = authUrl;
});

// =====================================================================
// 2. å›åˆ°æ­¤é æ™‚ â†’ è‡ªå‹•è§£æ ?code=xxxxx
// =====================================================================
async function checkOAuthLogin() {
    const url = new URL(window.location.href);
    const code = url.searchParams.get("code");

    if (!code) return; // æ²’ code = ä»æœªç™»å…¥

    // å‘¼å«å¾Œç«¯ï¼Œäº¤æ› token + å–å¾—ä½¿ç”¨è€…è³‡æ–™
    const res = await fetch(`${BACKEND}/auth?code=${code}`);
    const data = await res.json();

    if (data.success) {
        // ğŸ‰ æˆåŠŸç™»å…¥ï¼
        updateUI(data.user);
    } else {
        console.log("ç™»å…¥å¤±æ•—");
    }
}

// =====================================================================
// 3. æ›´æ–°å‰ç«¯ç•«é¢ï¼ˆé¡¯ç¤º Discord åç¨±ã€åˆ‡æ›æŒ‰éˆ•ï¼‰
// =====================================================================
function updateUI(user) {
    document.getElementById("username").innerText =
        `${user.username}#${user.discriminator}`;
    document.getElementById("username").classList.remove("visitor");

    // éš±è—ç™»å…¥ + é¡¯ç¤ºç™»å‡º
    document.getElementById("nav-right").innerHTML = `
        <button class="btn-logout" id="logout-btn">ç™»å‡º</button>
    `;

    // ç©å®¶è³‡æ–™é åŒæ­¥é¡¯ç¤º
    document.getElementById("p-discord").innerText =
        `${user.username}#${user.discriminator}`;

    // ç¶å®šç™»å‡ºäº‹ä»¶
    document.getElementById("logout-btn").addEventListener("click", logout);
}

// =====================================================================
// 4. ç™»å‡ºï¼ˆæ¸…é™¤ URL code ä¸¦é‡æ–°æ•´ç†ï¼‰
// =====================================================================
function logout() {
    window.location.href = REDIRECT_URI; // æ¸…é™¤ ?code=xxx
}

// =====================================================================
// 5. åˆå§‹åŒ–
// =====================================================================
checkOAuthLogin();
